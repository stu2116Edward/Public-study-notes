events {
    worker_connections 1024;  # 可以调整连接数
}

http {
    # ==================== HTTP 服务配置（80端口） ====================
    server {
        listen 80;
        server_name www.example.com;

        root /var/www/html;
        index index.html index.htm;

        access_log /var/log/nginx/get_access.log;
        error_log /var/log/nginx/get_error.log;

        # Shell 脚本下载
        location /sh/docker.sh {
            autoindex off;
            default_type application/x-sh;
            alias /var/www/html/sh/docker.sh;
        }

        # 文件下载目录
        location /downloads {
            alias /var/www/html/downloads;
            autoindex on;
        }

        # Debian 包目录
        location /deb/ {
            alias /var/www/html/deb/;
        }

        # GPG 密钥目录
        location /gpg/ {
            alias /var/www/html/gpg/;
        }

        # 压缩包目录
        location /tgz/ {
            alias /var/www/html/tgz/;
        }

        # Docker APT 仓库目录
        location /docker-apt-repo/ {
            alias /var/www/html/docker-apt-repo/;
            autoindex on;
        }

        # Docker Registry 代理配置（HTTP）
        location / {
            proxy_pass http://127.0.0.1:5002;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 传递认证头（重要：用于 Docker Registry 认证）
            proxy_set_header Authorization $http_authorization;
            proxy_pass_header Authorization;
            
            # 关闭缓存，否则 pull/push 会 500
            proxy_buffering off;
            proxy_request_buffering off;
        }
    }

    # ==================== HTTPS 服务配置（443端口） ====================
    server {
        listen 443 ssl;
        server_name www.example.com;

        # SSL 证书配置
        ssl_certificate /root/www.example.com/cert.crt;
        ssl_certificate_key /root/www.example.com/private.key;

        # SSL 安全配置
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers 'ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384';
        ssl_prefer_server_ciphers on;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;

        # 安全头部
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload";
        add_header X-Frame-Options "SAMEORIGIN";
        add_header X-Content-Type-Options "nosniff";

        root /var/www/html;
        index index.html index.htm;

        access_log /var/log/nginx/get_ssl_access.log;
        error_log /var/log/nginx/get_ssl_error.log;

        # Shell 脚本下载
        location /sh/docker.sh {
            autoindex off;
            default_type application/x-sh;
            alias /var/www/html/sh/docker.sh;
        }

        # 文件下载目录
        location /downloads {
            alias /var/www/html/downloads;
            autoindex on;
        }

        # Debian 包目录
        location /deb/ {
            alias /var/www/html/deb/;
        }

        # GPG 密钥目录
        location /gpg/ {
            alias /var/www/html/gpg/;
        }

        # 压缩包目录
        location /tgz/ {
            alias /var/www/html/tgz/;
        }

        # Docker APT 仓库目录
        location /docker-apt-repo/ {
            alias /var/www/html/docker-apt-repo/;
            autoindex on;
        }

        # Docker Registry 代理配置（HTTPS）
        location / {
            proxy_pass http://127.0.0.1:5002;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 传递认证头（重要：用于 Docker Registry 认证）
            proxy_set_header Authorization $http_authorization;
            proxy_pass_header Authorization;
            
            # 关闭缓存，否则 pull/push 会 500
            proxy_buffering off;
            proxy_request_buffering off;
        }
    }
}